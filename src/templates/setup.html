{% extends "base.html" %}

{% block title %}Setup Â· Jules Code Reviewer{% endblock %}

{% block quick_actions %}
<a class="button" href="{{ repo_url }}" target="_blank" rel="noopener">View Repository</a>
{% endblock %}

{% block content %}
<section class="hero">
    <h1>Deploy your Jules Code Reviewer app</h1>
    <p>Complete each step to register the GitHub App, capture credentials, and configure your deployment.</p>
</section>

<section class="card-grid">
    <article class="card">
        <h2>1. Review project resources</h2>
        <ul>
            <li>Source: <a href="{{ repo_url }}" target="_blank" rel="noopener">{{ repo_url }}</a></li>
            <li>Service base URL: <a href="{{ base_url }}" target="_blank" rel="noopener">{{ base_url }}</a></li>
            <li>Manifest endpoint: <a href="{{ manifest_url }}" target="_blank" rel="noopener">{{ manifest_url }}</a></li>
            <li>Webhook endpoint: <a href="{{ webhook_url }}" target="_blank" rel="noopener">{{ webhook_url }}</a></li>
        </ul>
    </article>

    <article class="card">
        <h2>2. Create your GitHub App</h2>
        <p>Use the manifest flow to prefill the GitHub registration form.</p>
        <form class="manifest-form" action="{{ manifest_launch_url }}" method="post" target="_blank" rel="noopener">
            <input type="hidden" name="manifest" value="{{ manifest_json | e }}" />
            <button type="submit" class="button button--primary">Create GitHub App</button>
        </form>
        <p class="hint">Trouble launching? Download the manifest JSON from <code>{{ manifest_url }}</code> and paste it manually.</p>
    </article>
</section>

<section class="card">
    <h2>3. Capture credentials from GitHub</h2>
    <ol>
        <li>After confirmation, GitHub redirects to <code>{{ register_url }}</code> with a temporary code.</li>
        <li>This service exchanges the code and shows your credentials only once.</li>
        <li>Download the PEM file immediately and store all values securely.</li>
    </ol>
</section>

<section class="card">
    <h2>4. Configure deployment secrets</h2>
    <ul class="env-list">
        {% for variable in env_variables %}
        <li>
            <div class="env-list__name">{{ variable.name }}</div>
            <div class="env-list__note">{{ variable.note }}</div>
        </li>
        {% endfor %}
    </ul>
</section>

<section class="card">
    <h2>5. Local quickstart</h2>
    <div class="command-grid">
        {% for cmd in quickstart_commands %}
        <div class="command-block">
            <div class="command-block__header">
                <span class="command-block__step">Step {{ cmd.step }}</span>
            </div>
            <div class="command-block__description">{{ cmd.description }}</div>
            <div class="command-block__code-wrapper">
                <button class="command-block__copy" data-command="{{ cmd.command | e }}" aria-label="Copy command">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5.5" y="5.5" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M10.5 2.5H4.5C3.67 2.5 3 3.17 3 4V10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <pre class="command-block__code"><code>{{ cmd.command }}</code></pre>
            </div>
        </div>
        {% endfor %}
    </div>
    <p class="hint">Ensure <code>SERVICE_BASE_URL</code> points to the public HTTPS endpoint for production.</p>
</section>

<section class="notice">
    <h2>Security reminders</h2>
    <p>Secrets are never stored by this service. Rotate credentials from the GitHub UI if compromised.</p>
</section>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const copyButtons = document.querySelectorAll('.command-block__copy');
        
        copyButtons.forEach(button => {
            button.addEventListener('click', async function() {
                const command = this.getAttribute('data-command');
                
                try {
                    await navigator.clipboard.writeText(command);
                    
                    // Visual feedback
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    this.style.color = 'var(--success)';
                    
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.style.color = '';
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = command;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        const originalHTML = this.innerHTML;
                        this.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                        this.style.color = 'var(--success)';
                        setTimeout(() => {
                            this.innerHTML = originalHTML;
                            this.style.color = '';
                        }, 2000);
                    } catch (fallbackErr) {
                        console.error('Fallback copy failed:', fallbackErr);
                    }
                    document.body.removeChild(textArea);
                }
            });
        });
    });
</script>
{% endblock %}
